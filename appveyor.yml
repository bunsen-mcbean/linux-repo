
image: Ubuntu2004

environment:
    APPVEYOR_CONSOLE_DISABLE_PTY: true
    SNAPSHOT: 2021-04-01
    CRAN_MIRROR: https://cran.microsoft.com/snapshot/2021-04-01
    R_LIBS_USER: libs
    SFTP_KEY:
        secure: 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
    SFTP_USER:
        secure: l4mG8sI6N3F1niJ6euSU3A==
    SFTP_KNOWNHOSTS:
        secure: J4PhvJkySks9v0kRrhCHJYaFZcEbNq1X1v0aDwrsACvDP7BK6MPUr37A7hjW2iuMgv9X2yYEcnm4u07E1X4fICr6mEH5xZhUuYsTf3jGYEPap3yk4VYz8mKPMemL/zmDNXigdgX/eswuvkibX7jcrgsZvmCFz1uWqW4OG3eS3JyjRJ46ZlUjtrmXVAUF8G74sBuG8WiIkW2G5p+DRWRuiTjHzNoO4P+1iYppN2ZrkyQs5qpy1CysW6D52z/n17TTSqyOiuRYAXlecvr4b8v4rKHZoyZmOEggopx74cRz+4rvy9xBh3rkYKy5vGl6PxSJrbA7V3+MnSs9+wuWE8dctjxv24S9CGl7n/gkLnQpuyVmDq2JuClEfeLlvdDH+PVXAtRG61x4xiP17yG9Ldoh2ghYNlBhfN6QcIm2h8wzMq2gANjjBbf0N8mz4D2VjkLvi+oYyz0ijney+XAWRDSRjyYUg+u0NDbcFWXP9QgIXaM=

install:
  - sudo apt update
  - sudo apt install -y flatpak python3 python3-pip rename curl
  
  - bash install-flatpak.sh
  - export APPVEYOR_SAVE_CACHE_ON_ERROR=true
  - python3 -m pip install -r requirements.txt

build_script:
  - export R_VERSION=`flatpak run org.jamovi.jamovi --r-version`
  - mkdir -p $R_LIBS_USER
  - python3 download.py --packages drat `sed -e ':a' -e 'N' -e '$!ba' -e 's/\n/ /g' packages.txt`
  - flatpak run --devel org.jamovi.jamovi -R CMD INSTALL --build *.tar.gz --library=$R_LIBS_USER
  - rename 's/^(.*)_R_x86_64-pc-linux-gnu\.tar\.gz$/$1.tar.gz.tmp/' *_R_x86_64-pc-linux-gnu.tar.gz
  - rm -rf *.tar.gz
  - rename 's/^(.*)\.tmp/$1/' *.tar.gz.tmp
  - mkdir -p $R_VERSION
  - mkdir -p $R_VERSION/$SNAPSHOT
  - flatpak run --devel org.jamovi.jamovi -R -e "options(dratRepo='$APPVEYOR_BUILD_FOLDER/$R_VERSION/$SNAPSHOT'); lapply(list.files(pattern='\\\\.tar\\\\.gz$'), drat::insertPackage); invisible(NULL)"

after_build:
  - mkdir -p ~/.ssh
  - chmod 0700 ~/.ssh
  - echo "${SFTP_KEY}" | base64 --decode >~/.ssh/id_rsa
  - chmod 0600 ~/.ssh/id_rsa
  - echo "${SFTP_KNOWNHOSTS}" | base64 --decode >>~/.ssh/known_hosts
  - scp -r -o IdentityFile=~/.ssh/id_rsa "$APPVEYOR_BUILD_FOLDER/$R_VERSION" ${SFTP_USER}@jamovi.org:/home/${SFTP_USER}/jamovi.org/downloads/repo

cache:
  - /home/appveyor/.local/share/flatpak/app/org.jamovi.jamovi -> install-flatpak.sh
